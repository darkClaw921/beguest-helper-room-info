# Архитектура проекта BeGuest Helper Room Info

## Основные файлы и их назначение

### handlers.py
Основной файл с обработчиками сообщений бота. Содержит логику взаимодействия с пользователем:
- Обработка команды `/start` для ввода номера телефона
- Проверка пользователя через Битрикс24
- Запрос информации о квартире
- Обработка файлов и фотографий для проверки оплаты
- Обновление статуса сделки в Битрикс24
- Middleware для проверки регистрации пользователя перед обработкой сообщений
- Скачивание и отправка различных типов файлов (видео, фото, документы) из Яндекс.Диска

### workBitrix.py
Модуль для взаимодействия с API Битрикс24:
- Функции для поиска контактов по номеру телефона
- Функции для поиска сделок по ID контакта
- Функция обновления статуса сделки
- Другие вспомогательные функции для работы с Битрикс24

### workGS.py
Модуль для работы с Google Sheets:
- Получение данных о квартирах из таблицы
- Подготовка информации для отображения пользователю
- Обработка различных типов URL (Яндекс.Диск и Яндекс.Документы)
- Преобразование ссылок в относительные пути для дальнейшей работы

### workKeyboard.py
Модуль для создания клавиатур:
- Генерация инлайн-клавиатур для взаимодействия с ботом
- Фильтрация информации для отображения в разных разделах
- Создание специальных кнопок для скачивания видеофайлов из Яндекс.Диска

### ydWork.py
Модуль для работы с Яндекс.Диском (старая версия):
- Загрузка файлов на Яндекс.Диск из URL или локальных файлов
- Создание папок
- Получение списка папок и файлов

### yadisk_downloader.py
Новый модуль для скачивания файлов с Яндекс.Диска:
- Скачивание файлов по известному пути
- Асинхронное скачивание файлов
- Получение метаданных файлов
- Проверка существования файлов
- Получение прямых ссылок на скачивание
- Кеширование скачанных файлов для повторного использования

### compressor_video.py
Модуль для сжатия видеофайлов:
- Сжатие видео до заданного размера (по умолчанию до 50 МБ)
- Адаптивное изменение битрейта видео и аудио в зависимости от длительности и требуемого размера
- Двухпроходное кодирование для обеспечения лучшего качества
- Автоматические повторные попытки сжатия с более агрессивными параметрами
- Очистка временных файлов после сжатия
- Проверка итогового размера файла

## Логика работы бота

1. Пользователь отправляет команду `/start` и вводит номер телефона
2. Бот проверяет номер телефона в системе Битрикс24
3. При успешной проверке пользователь вводит название квартиры
4. Бот отображает информацию о квартире с интерактивной клавиатурой
5. При выборе файлов (видео, фото, документы) бот скачивает и отправляет их пользователю
6. Файлы сохраняются локально, а их file_id кешируются для повторного использования

## Структура данных

### USER_PHONES
Словарь для хранения информации о пользователях:
- Ключ: номер телефона пользователя
- Значение: словарь с ID пользователя в Telegram, ID сделки в Битрикс24 и статусом сделки

### user_rooms
Словарь для хранения информации о квартирах:
- Ключ: ID пользователя в Telegram
- Значение: информация о квартире из Google Sheets 

### file_id_cache
Словарь для кеширования file_id отправленных файлов:
- Ключ: локальный путь к файлу
- Значение: file_id, возвращенный Telegram API

## Middleware

### RegistrationMiddleware
Промежуточное ПО для проверки регистрации пользователя:
- Перехватывает все входящие сообщения
- Пропускает коллбэки и команду `/start`
- Проверяет, находится ли пользователь в процессе регистрации
- Если пользователь не зарегистрирован, предлагает ему выполнить команду `/start` 